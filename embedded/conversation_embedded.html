<!--
  Forsta Embedded Conversation Example
  Creates an embedded conversation for an already existing user and gives a link to add other users
-->
<html>
  <head>
    <title>Forsta Embedded Conversation</title>
    
    <!-- Stylesheet to make the example code look nice -->
    <link rel="stylesheet" href="https://unpkg.com/tachyons@4.10.0/css/tachyons.min.css"/>

    <!-- Google recaptcha required for the Forsta start conversation API call -->
     <script src="https://www.google.com/recaptcha/api.js" async defer></script>

     <script src="https://code.jquery.com/jquery-3.4.0.min.js"></script>

     <script>
       function onSubmit(token) {

         // Make sure the error class is hidden if we are retrying
         $("#errors").addClass("hidden");
         
         // Forsta api call to create a conversation
         $.ajax({
           url: "https://atlas.forsta.io/v1/conversations",
           type: "post",
           data: { captcha: token },
           success: data => {
             link = "https://app.forsta.io/@chat/" + data.token;
             html = '<iframe src="' + link + '" allow="microphone;camera;fullscreen" width=600 height=600></iframe>'
             $("#embedded").html(html);
             $("#conversation_link").html('Share the meeting with: <div class="di green b">' + link + "</div>");
           },
           
           // API Error handling. Appends any errors to div id="errors"
           error: err => {
             $("#errors").html("");
             $.each( err.responseJSON, function( key, value ) {
               $("#errors").append( "<p>" + key + ": " + value + "</p>" );
             });             
             $("#errors").removeClass("hidden");
           }

         });
       }
     </script>

  </head>

  <body>

    <article class="pa2 pa4-ns helvetica">
      <h1 class="f3 black-80 pb1 bb b--black-30">Forsta Embedded Conversation</h1>

      <div id="content" class="">
        <div id="embedded">

          <!-- Recaptcha enabled form that calls back to the onSubmit function defined above -->
          <form id='demo-form' action="?" method="POST">
          
            <!-- Note: This will NOT work unless you are an approved Forsta vendor who has registered their 
                Recaptcha secret key with our server. Please contact Forsta.io if interested.
                Once your secret key is configured enter your site key below -->
            <button class="g-recaptcha link dim br3 ph3 pv2 mb2 dib white bg-green b--green" data-sitekey="add recaptcha key here" data-callback='onSubmit'>
              Start Conversation
            </button>

          </form>
        
          <!-- onSubmit will append API errors to this div -->
          <div id="errors" class="red hidden"></div>
        </div>

        <p id="conversation_link" class=""></p>
      </div>

    </article>

  </body>
</html>
